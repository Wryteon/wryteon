---
import BlockRenderer, { type Block } from "./BlockRenderer.astro";
import type { PostRecord } from "../../lib/db";

interface Props {
    post: PostRecord;
    showBackLink?: boolean;
    backLinkHref?: string;
}

const { post, showBackLink = true, backLinkHref = "/blog" } = Astro.props;

const blockDocument = (post.blocks as { blocks?: Block[] } | null) ?? {
    blocks: [],
};
const renderedBlocks: Block[] = blockDocument.blocks ?? [];

const hasText = (block: Block): block is Block & { data: { text: string } } =>
    typeof block.data === "object" &&
    block.data !== null &&
    typeof (block.data as { text?: unknown }).text === "string";

const firstBlockText = renderedBlocks.find(hasText)?.data.text ?? "";
const publishedAt =
    post.publishedAt instanceof Date
        ? post.publishedAt
        : new Date(post.publishedAt ?? new Date());
---

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="viewport" content="width=device-width" />
        <meta name="generator" content={Astro.generator} />
        <title>{post.title} - Wryteon</title>
        <meta name="description" content={firstBlockText.substring(0, 160)} />
        <style>
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                margin: 0;
                padding: 20px;
                background: #f5f5f5;
                line-height: 1.6;
            }
            .container {
                max-width: 800px;
                margin: 0 auto;
                background: white;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                padding: 40px;
            }
            .post-header {
                margin-bottom: 40px;
                padding-bottom: 20px;
                border-bottom: 1px solid #e1e5e9;
            }
            .post-title {
                margin: 0 0 10px 0;
                font-size: 32px;
                line-height: 1.2;
            }
            .post-meta {
                color: #666;
                font-size: 14px;
            }
            .post-content {
                font-size: 18px;
                line-height: 1.7;
            }
            .post-content h1,
            .post-content h2,
            .post-content h3,
            .post-content h4,
            .post-content h5,
            .post-content h6 {
                margin-top: 2rem;
                margin-bottom: 1rem;
                line-height: 1.3;
            }
            .post-content p {
                margin-bottom: 1.5rem;
            }
            .back-link {
                display: inline-block;
                margin-bottom: 20px;
                color: #007acc;
                text-decoration: none;
            }
            .back-link:hover {
                text-decoration: underline;
            }
            .edit-link {
                display: inline-block;
                margin-top: 40px;
                padding: 10px 20px;
                background: #007acc;
                color: white;
                text-decoration: none;
                border-radius: 4px;
            }
            .edit-link:hover {
                background: #005aa3;
            }
        </style>
    </head>
    <body>
        <div class="container">
            {
                showBackLink && (
                    <a href={backLinkHref} class="back-link">
                        ‚Üê Back to posts
                    </a>
                )
            }

            <div class="post-header">
                <h1 class="post-title">{post.title}</h1>
                <div class="post-meta">
                    Published on {publishedAt.toLocaleDateString()}
                </div>
            </div>

            <div class="post-content">
                <BlockRenderer blocks={renderedBlocks} />
            </div>

            <a href={`/admin/${post.slug}`} class="edit-link">Edit this post</a>
        </div>
    </body>
</html>
